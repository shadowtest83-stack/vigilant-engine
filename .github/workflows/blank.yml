name: Continuous Persistent VPS

on:
  workflow_dispatch:  # manual trigger
  schedule:
    - cron: "30 */5 * * *"  # every 5 hours 30 minutes (UTC approximation)

jobs:
  vps-session:
    runs-on: ubuntu-latest
    steps:
    # 1. Checkout repo
    - name: Checkout repo
      uses: actions/checkout@v4

    # 2. Install prerequisites
    - name: Install prerequisites
      run: |
        sudo apt update && sudo apt upgrade -y
        sudo apt install -y curl unzip zip rsync sudo net-tools software-properties-common apt-transport-https ca-certificates gnupg lsb-release wget

    # 3. Install Docker
    - name: Install Docker
      run: |
        sudo apt-get remove -y containerd containerd.io || true
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        sudo apt update
        sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
        sudo systemctl enable docker
        sudo systemctl start docker

    # 4. Restore VPS backup (must come before Tailscale/Playit)
    - name: Download Backup
      uses: actions/download-artifact@v4
      with:
        name: vps-backup
        path: ./backup

    - name: Extract Backup
      run: |
        if [ -f ./backup/backup.zip ]; then
          unzip -o ./backup/backup.zip -d /opt/vps-backup
        fi

    # 5. Install & Connect Tailscale
    - name: Install Tailscale
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up \
          --authkey ${{ secrets.TAILSCALE_AUTHKEY }} \
          --hostname gha-vps \
          --accept-routes \
          --accept-dns \
          --ssh || echo "Tailscale may already be connected"

    # 6. Start Playit agent
    - name: Start Playit agent
      run: |
        if [ ! -f ./playit-linux ]; then
          wget https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux
          chmod +x ./playit-linux
        fi
        if [ -d /opt/vps-backup/data/playit ]; then
          mkdir -p ~/.playit
          cp -r /opt/vps-backup/data/playit/* ~/.playit/
        fi
        nohup ./playit-linux &>/dev/null &

    # 7. Start Docker containers
    - name: Start Docker containers
      run: |
        if [ -f docker-compose.yml ]; then
          docker compose up -d
        fi

    # 8. Show IPs for debug
    - name: Show IPs
      run: |
        echo "Public IPv4 via Playit:"
        cat ~/.playit/public-ip.txt || echo "Playit IP not found"
        echo "Tailscale IP:"
        tailscale ip -4

    # 9. Backup VPS state for next run
    - name: Backup VPS
      run: |
        mkdir -p /opt/vps-backup/data/playit
        cp -r ~/.playit/* /opt/vps-backup/data/playit/ || true
        zip -r backup.zip /opt/vps-backup

    - name: Upload Backup
      uses: actions/upload-artifact@v4
      with:
        name: vps-backup
        path: backup.zip
